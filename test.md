# ุฑุงูููุง ุชุณุช ุฏุณุชุงุฑ ููุด ูุตููุน ูุฏุฑ ๐ค

## โ ุชุบุฑุงุช ุงูุฌุงู ุดุฏู

### ูุดฺฉู ุงุตู
ูุชุฏ `.stream()` ุฏุฑ LangChain ูพุงุฑุงูุชุฑ ุฏูู (options ุจุง signal) ุฑุง ูพุดุชุจุงู ููโฺฉุฑุฏ ู ุจุงุนุซ ุฎุทุง "Internal Server Error" ูโุดุฏ.

### ุฑุงูโุญู
ุญุฐู ุด options ุงุฒ ูุฑุงุฎูุงูโูุง `.stream()` ุฏุฑ ุฏู ูุญู:
1. **ุฎุท 819-862**: ูุฑุงุฎูุงู `narrativeModel.stream()`
2. **ุฎุท 925-930**: ูุฑุงุฎูุงู `generalModel.stream()`

---

## ๐งช ุฑูุด ุชุณุช

### ฺฏุฒูู 1: ุชุณุช ุฏุฑ ูุฑูุฑฺฏุฑ (ุชูุตู ูโุดูุฏ)

1. **ูุฑูุฏ ุจู ุณุณุชู**:
   ```
   http://localhost:3000/signin
   ```
   - ุจุง ุญุณุงุจ ฺฉุงุฑุจุฑ ูุฏุฑ ูุงุฑุฏ ุดูุฏ

2. **ุจุงุฒ ฺฉุฑุฏู ุฏุณุชุงุฑ ููุด ูุตููุน**:
   ```
   http://localhost:3000/dashboard/principal/principal-assistant
   ```

3. **ุงุฑุณุงู ุณูุงู ุชุณุช**:
   ```
   ูุถุนุช ฺฉูุซุฑ ุฒูู ุฏุฑ ุฏุฑุณ ุฑุงุถ ฺฺฏููู ุงุณุชุ
   ```

4. **ูุชุฌู ููุฑุฏ ุงูุชุธุงุฑ**:

   ูพุงุณุฎ ุจุงุฏ ุดุงูู ููุงุฑุฏ ุฒุฑ ุจุงุดุฏ:

   ```markdown
   ## ุฎูุงุตู ุนููฺฉุฑุฏ
   | ุดุงุฎุต | ููุฏุงุฑ |
   | --- | --- |
   | ุชุนุฏุงุฏ ูุนุงูุชโูุง | ฒ |
   | ูุงูฺฏู ููุฑุงุช | ฑถ.ฐฐ |
   | ุชุงุฑุฎ ุขุฎุฑู ูุนุงูุช | ฑดฐด/ฑฑ/ฐด |

   ## ุขุฎุฑู ูุนุงูุชโูุง
   | ุชุงุฑุฎ | ููุน | ุนููุงู | ููุฑู | ุงุฑุฒุงุจ ฺฉู | ฺฉูุงุณ |
   | --- | --- | --- | --- | --- | --- |
   | ฑดฐด/ฑฑ/ฐด | ุชฺฉูู | ... | ฑถ | ... | ุจ |
   | ฑดฐด/ฑฑ/ฐด | ุขุฒููู ูพุงุงู ุชุฑู | ... | ฑถ | ... | ุจ |

   ## ุชูุถุญ ุชฺฉูู
   [ุชุญูู ูุจุชู ุจุฑ ุฏุงุฏูโูุง ูุงูุน ุจุฏูู ุชููู]
   ```

---

## ๐ ูฺฉุงุช ุจุฑุฑุณ

### โ ููุงุฑุฏ ุตุญุญ (ุจุงุฏ ุฏุฑ ูพุงุณุฎ ุจุงุดุฏ):

- โ ูุงู ุฏุงูุดโุขููุฒ: **ฺฉูุซุฑ ุฒูู**
- โ ูุงู ุฏุฑุณ: **ุฑุงุถ**
- โ ุชุนุฏุงุฏ ูุนุงูุชโูุง: **ฒ**
- โ ูุงูฺฏู ููุฑุงุช: **ฑถ.ฐฐ**
- โ ุชุงุฑุฎ: **ฑดฐด/ฑฑ/ฐด**
- โ ููุน ูุนุงูุชโูุง: **ุชฺฉูู** ู **ุขุฒููู ูพุงุงู ุชุฑู**
- โ ูุงู ูุนูู: **ููุง ุฑุงุฑุณุง** (ุฏุฑ ุตูุฑุช ูุฌูุฏ ุฏุฑ ุฏุงุฏู)
- โ ูุงู ฺฉูุงุณ: **ุจ**

### โ ููุงุฑุฏ ูุงุฏุฑุณุช (ูุจุงุฏ ุฏุฑ ูพุงุณุฎ ุจุงุดุฏ):

- โ ููุฑูโูุง ุฌุนู (ูุซู ฑธุ ฑด ฺฉู ุฏุฑ ุฏุชุงุจุณ ูุณุชูุฏ)
- โ ุชุงุฑุฎโูุง ุชุตุงุฏู
- โ ูุนุงูุชโูุง ุงุถุงูู ฺฉู ุซุจุช ูุดุฏูโุงูุฏ
- โ ุญุฏุณ ู ฺฏูุงู (ูุซู "ุงุญุชูุงูุงู...")
- โ ูพุดโุจู (ูุซู "ุฏุฑ ุขุฒููู ุจุนุฏ ุจูุชุฑ ูโุดูุฏ")

---

## ๐ ุนุจโุงุจ

### ูุดฺฉู: "Internal Server Error"

**ุนูุช**: ููฺฉู ุงุณุช ุชุบุฑุงุช ูููุฒ ุงุนูุงู ูุดุฏู ุจุงุดูุฏ

**ุฑุงูโุญู**:
```bash
# ุณุฑูุฑ ุฑุง ูุชููู ฺฉูุฏ (Ctrl+C)
# ุณูพุณ ูุฌุฏุฏุงู ุงุฌุฑุง ฺฉูุฏ
npm run dev
```

### ูุดฺฉู: "ุฎุทุง ุฏุฑ ุฏุฑุงูุช ูพุงุณุฎ"

**ุนูุช**: ูุดฺฉู ุฏุฑ ุงุฑุชุจุงุท ุจุง OpenAI API

**ุฑุงูโุญู**:
1. ุจุฑุฑุณ ฺฉูุฏ ฺฉู `OPENAI_API_KEY` ุฏุฑ `.env` ุชูุธู ุดุฏู ุจุงุดุฏ
2. ูุงฺฏโูุง ุณุฑูุฑ ุฑุง ุจุฑุฑุณ ฺฉูุฏ

### ูุดฺฉู: "ุฏุงูุดโุขููุฒ ุจุง ุงู ูุงู ูพุฏุง ูุดุฏ"

**ุนูุช**: ุฏุงูุดโุขููุฒ ุฏุฑ ุฏุชุงุจุณ ูุฌูุฏ ูุฏุงุฑุฏ ุง ูุงู ุงุดุชุจุงู ุงุณุช

**ุฑุงูโุญู**:
1. ุงููุง ูุงู ุฑุง ุจุฑุฑุณ ฺฉูุฏ
2. ูุทูุฆู ุดูุฏ ุฏุงูุดโุขููุฒ ุฏุฑ ุณุณุชู ุซุจุช ุดุฏู ุงุณุช
3. ุณูุงู ุฏฺฏุฑ ุจุง ูุงู ุฏุงูุดโุขููุฒ ููุฌูุฏ ุงูุชุญุงู ฺฉูุฏ

---

## ๐ ุณูุงูุงุช ุชุณุช ุงุถุงู

ุจุฑุง ุชุณุช ฺฉุงููโุชุฑุ ุงู ุณูุงูุงุช ุฑุง ุงูุชุญุงู ฺฉูุฏ:

```
1. ูุถุนุช ุนู ุงุญูุฏ ุฏุฑ ููู ุฏุฑูุณ
2. ููุฑุงุช ูุญูุฏ ฺฉุฑู ุฏุฑ ูุงุฑุณ
3. ุนููฺฉุฑุฏ ุณุงุฑุง ุฑุถุง ุฏุฑ ุนููู ุชุฌุฑุจ
4. ูุนุงูุชโูุง ุงุฎุฑ ุฒูุฑุง ูุญูุฏ
5. ุขุฎุฑู ูุถุนุช ุฏุงูุดโุขููุฒ ฺฉูุซุฑ ุฒูู
```

---

## โจ ูฺฺฏโูุง ุจูุจูุฏ ุงูุชู

### 1. Function Call ุฏููโุชุฑ
- ุงุณุชุฎุฑุงุฌ ุฏูู ูุงู ุฏุงูุดโุขููุฒ (ูุงู + ูุงู ุฎุงููุงุฏฺฏ)
- ุงุณุชุฎุฑุงุฌ ุฏูู ูุงู ุฏุฑุณ
- ุนุฏู ุญุฏุณ ุง ุชุฎูู

### 2. ููุงูู Anti-Hallucination
- ููููุนุช ุฌุนู ููุฑู
- ููููุนุช ุฌุนู ุชุงุฑุฎ
- ููููุนุช ุญุฏุณ ู ฺฏูุงู
- ุงูุฒุงู ุจู ูพุงุจูุฏ ุจู ุฏุงุฏูโูุง ุฏุชุงุจุณ

### 3. Prompt ุจูุจูุฏ ุงูุชู
- ุฏุณุชูุฑุงูุนููโูุง ูุงุถุญ ุจุฑุง ุชุญูู
- ูุซุงูโูุง ุตุญุญ ู ุบูุท
- ุชุฃฺฉุฏ ุจุฑ ุนุฏู ุชุบุฑ ุฌุฏุงูู

### 4. ุชูุงุจุน Validation ุฌุฏุฏ
- `validateStudentInClass`: ุงุนุชุจุงุฑุณูุฌ ุนุถูุช ุฏุงูุดโุขููุฒ
- `getStudentActiveSubjects`: ุฏุฑุงูุช ุฏุฑูุณ ูุนุงู ุฏุงูุดโุขููุฒ

---

## ๐ ูุณุชูุฏุงุช ูุฑุชุจุท

- [PRINCIPAL_ASSISTANT_IMPROVEMENTS.md](./docs/PRINCIPAL_ASSISTANT_IMPROVEMENTS.md)
- [DATABASE_STRUCTURE.md](./docs/DATABASE_STRUCTURE.md)
- [AI_INTEGRATION.md](./docs/AI_INTEGRATION.md)

---

**ุชุงุฑุฎ ุขุฎุฑู ุจุฑูุฒุฑุณุงู**: ฑดฐด/ฑฑ/ฑท
**ูุณุฎู**: 10.2
**ูุถุนุช**: โ ุขูุงุฏู ุชุณุช

---

<div dir="rtl">

## ุฎูุงุตู ูุนูุงุฑ ุณุณุชู

**ุฎูุงุตู ุนููฺฉุฑุฏ ุฏุณุชุงุฑ ูุฏุฑ (`/dashboard/principal/principal-assistant`)**

1. **ูุฑูุฏ ุจู ุตูุญู ู ุงุญุฑุงุฒ ููุด**
- ุตูุญู `principal-assistant` ุงุจุชุฏุง `GET /api/auth/me` ูโุฒูุฏ.
- ุงฺฏุฑ ฺฉุงุฑุจุฑ ูุฏุฑ ูุจุงุดุฏุ ูุงุฑุฏ ุงู ุจุฎุด ููโุดูุฏ.
- ุณูพุณ `ChatContainer` ุจุง `apiPath="/api/principal/ai-assistant"` ุงุฌุฑุง ูโุดูุฏ.

2. **ุงุฑุณุงู ูพุงู ุงุฒ ูุฑุงูุช**
- `useChat.sendMessage` ูพุงูโูุง ุฑุง ุจู `POST /api/principal/ai-assistant` ูโูุฑุณุชุฏ.
- ูพุงุณุฎ ุจูโุตูุฑุช **ุงุณุชุฑู** ุฏุฑุงูุช ูโุดูุฏ ู ูุชู ูพุงู ุฏุณุชุงุฑ ูุญุธูโุง ุจูโุฑูุฒุฑุณุงู ูโุดูุฏ.

3. **ูุณุฑ ูพุฑุฏุงุฒุด ุฏุฑ API**
- API ุงุฒ `user_session` ฺฉุงุฑุจุฑ ุฑุง ูโุฎูุงูุฏ ู ููุท ููุด `principal` ุฑุง ูุจูู ูโฺฉูุฏ.
- ูพุฑุงููพุช ูพุงู ูุฏุฑ ุงุฒ `getRolePromptConfig("principal")` ูโุขุฏ.
- ุฏู ูุฏู ุณุงุฎุชู ูโุดูุฏ:
  - `generalModel`: ุณูุงูุงุช ุนููู
  - `narrativeModel`: ุชูุถุญ ุชฺฉูู ุจุฑุง ูพุงุณุฎโูุง ุฏุงุฏูโูุญูุฑ

4. **ุงฺฏุฑ ุณูุงู ุฏุฑุจุงุฑู ุฏุงูุดโุขููุฒ ุจุงุดุฏ**
- ุจุง `isStudentQuestion` ุชุดุฎุต ุฏุงุฏู ูโุดูุฏ.
- ูุงู ุฏุงูุดโุขููุฒ ุจุง `extractStudentName` ุงุณุชุฎุฑุงุฌ ูโุดูุฏ.
- ุฌุณุชุฌู ุจุง `searchStudentsForPrincipal`:
  - ุงฺฏุฑ ูพุฏุง ูุดูุฏ: ูพุงู ุฑุงูููุง
  - ุงฺฏุฑ ฺูุฏ ููุฑ ููโูุงู ุจุงุดูุฏ: ุฏุฑุฎูุงุณุช ูพุงู/ฺฉูุงุณ
- ููุช ูุทุน ุจุง `getStudentIdentityForPrincipal` ฺฏุฑูุชู ูโุดูุฏ.
- ุงฺฏุฑ ุณูุงู ยซููู ุฏุฑูุณยป ูุจุงุดุฏ:
  - ุฏุฑูุณ ูุฏุฑุณู ุจุง `getSubjectNamesForPrincipal`
  - ุชุทุจู ุฏุฑุณ ุจุง `resolveSubjectFromList`
- ูุนุงูุชโูุง ุจุง `getStudentActivitiesForPrincipal` (ุญุฏุงฺฉุซุฑ 20 ููุฑุฏ ุขุฎุฑ) ฺฏุฑูุชู ูโุดูุฏ.
- ุงุจุชุฏุง ุฌุฏูู ุฎูุงุตู/ูุนุงูุชโูุง ุณุงุฎุชู ูโุดูุฏุ ุณูพุณ `narrativeModel.stream` ฺฉ ุชูุถุญ ฺฉูุชุงู ุชฺฉูู ุชููุฏ ูโฺฉูุฏ.

5. **ุงฺฏุฑ ุณูุงู ุฏุงูุดโุขููุฒ ูุจุงุดุฏ**
- ูุณุชูู ุจุง `generalModel.stream` ูพุงุณุฎ ุฏุงุฏู ูโุดูุฏ ู ูฺ ฺฉูุฆุฑ ุฏุงูุดโุขููุฒ ุงุฌุฑุง ููโุดูุฏ.

6. **ูพุฑุงููพุช ูพุงุณุฎโุฏู**
- ูุณุชู ูพุฑุงููพุช ุงุฒ `src/lib/aiPrompts.ts` (ุจุฎุด `principal.systemPrompt`) ูโุขุฏ.
- ุฏุฑ ุณูุงูุงุช ุฏุงูุดโุขููุฒุ `assistantRules` + ุฏุงุฏูโูุง ุงุณุชุฎุฑุงุฌโุดุฏู ุงุฒ ุฏุชุงุจุณ + ุฌุฏุงูู ูุฒ ุจู `SystemMessage` ุงุถุงูู ูโุดูุฏ ุชุง ูพุงุณุฎ ููุท ุฏุงุฏูโูุญูุฑ ู ุฏูู ุจุงุดุฏ.

7. **ุงููุช ู Read-only ุฏุชุงุจุณ**
- ุชูุงู ุชูุงุจุน ุงู ุจุฎุด ุฏุฑ `src/lib/principalAssistantStudentData.ts` ุฏุงุฎู `BEGIN READ ONLY` ุงุฌุฑุง ูโุดููุฏ.
- `statement_timeout` ูู ุชูุธู ุดุฏู ุงุณุช.
- ููุชุฑ ูุฏุฑุณู (`school_id`) ุฏุฑ ฺฉูุฆุฑโูุง ุงุนูุงู ูโุดูุฏ ุชุง ูุดุช ุฏุงุฏู ุจู ูุฏุงุฑุณ ุฑุฎ ูุฏูุฏ.

</div>